(()=>{"use strict";class e{constructor(){this.STORAGE_KEYS={PRIVACY_CONFIG:"ghostlink_privacy_config",RECEIPTS:"ghostlink_receipts",USER_PREFERENCES:"ghostlink_user_preferences",PRIVACY_STATS:"ghostlink_privacy_stats"}}async getPrivacyConfig(){try{return(await chrome.storage.sync.get(this.STORAGE_KEYS.PRIVACY_CONFIG))[this.STORAGE_KEYS.PRIVACY_CONFIG]||null}catch(e){return console.error("Error getting privacy config:",e),null}}async setPrivacyConfig(e){try{await chrome.storage.sync.set({[this.STORAGE_KEYS.PRIVACY_CONFIG]:e})}catch(e){throw console.error("Error setting privacy config:",e),e}}async storeReceipt(e){try{const t=await this.getReceipts();t.push(e);const a=await this.getPrivacyConfig(),r=a?.retentionDays||30,i=Date.now()-24*r*60*60*1e3,n=t.filter(e=>e.timestamp>i);await chrome.storage.local.set({[this.STORAGE_KEYS.RECEIPTS]:n})}catch(e){throw console.error("Error storing receipt:",e),e}}async getReceipts(e){try{const t=(await chrome.storage.local.get(this.STORAGE_KEYS.RECEIPTS))[this.STORAGE_KEYS.RECEIPTS]||[];return t.sort((e,t)=>t.timestamp-e.timestamp),e?t.slice(0,e):t}catch(e){return console.error("Error getting receipts:",e),[]}}async clearReceipts(){try{await chrome.storage.local.remove(this.STORAGE_KEYS.RECEIPTS)}catch(e){throw console.error("Error clearing receipts:",e),e}}async getUserPreferences(){try{return(await chrome.storage.sync.get(this.STORAGE_KEYS.USER_PREFERENCES))[this.STORAGE_KEYS.USER_PREFERENCES]||null}catch(e){return console.error("Error getting user preferences:",e),null}}async setUserPreferences(e){try{await chrome.storage.sync.set({[this.STORAGE_KEYS.USER_PREFERENCES]:e})}catch(e){throw console.error("Error setting user preferences:",e),e}}async getPrivacyStats(){try{return(await chrome.storage.local.get(this.STORAGE_KEYS.PRIVACY_STATS))[this.STORAGE_KEYS.PRIVACY_STATS]||null}catch(e){return console.error("Error getting privacy stats:",e),null}}async updatePrivacyStats(e){try{const t={...await this.getPrivacyStats()||{totalQueries:0,totalPIIRemoved:0,avgAnonymityScore:0,lastQuery:null,queriesByDay:{},piiByType:{}},...e};await chrome.storage.local.set({[this.STORAGE_KEYS.PRIVACY_STATS]:t})}catch(e){throw console.error("Error updating privacy stats:",e),e}}async exportData(){try{const[e,t,a,r]=await Promise.all([this.getPrivacyConfig(),this.getReceipts(),this.getUserPreferences(),this.getPrivacyStats()]);return{version:"1.0.0",exportDate:(new Date).toISOString(),data:{privacyConfig:e,receipts:t,userPreferences:a,privacyStats:r}}}catch(e){throw console.error("Error exporting data:",e),e}}async importData(e){try{e.data.privacyConfig&&await this.setPrivacyConfig(e.data.privacyConfig),e.data.userPreferences&&await this.setUserPreferences(e.data.userPreferences),e.data.receipts&&await chrome.storage.local.set({[this.STORAGE_KEYS.RECEIPTS]:e.data.receipts}),e.data.privacyStats&&await chrome.storage.local.set({[this.STORAGE_KEYS.PRIVACY_STATS]:e.data.privacyStats})}catch(e){throw console.error("Error importing data:",e),e}}async clearAllData(){try{await Promise.all([chrome.storage.sync.clear(),chrome.storage.local.clear()])}catch(e){throw console.error("Error clearing all data:",e),e}}}class t{async generateHash(e){try{const t=(new TextEncoder).encode(e),a=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(a)).map(e=>e.toString(16).padStart(2,"0")).join("")}catch(e){throw console.error("Error generating hash:",e),e}}generateReceiptId(){return`gl_${Date.now().toString(36)}_${Math.random().toString(36).substr(2,9)}`}async createPrivacyReceipt(e,t,a,r,i={}){try{const n=Date.now(),s=this.generateReceiptId(),o={id:s,timestamp:n,originalHash:await this.generateHash(e),processedHash:await this.generateHash(t),site:a,privacyLevel:r,...i},c=await this.signReceipt(o);return{...o,signature:c}}catch(e){throw console.error("Error creating privacy receipt:",e),e}}async signReceipt(e){try{const t=`ghostlink_v1_${JSON.stringify(e,Object.keys(e).sort())}_${e.timestamp}`;return await this.generateHash(t)}catch(e){throw console.error("Error signing receipt:",e),e}}async verifyReceipt(e){try{if(!e.signature)return!1;const{signature:t,...a}=e;return t===await this.signReceipt(a)}catch(e){return console.error("Error verifying receipt:",e),!1}}generateSecureRandom(e=16){return crypto.getRandomValues(new Uint8Array(e))}generateDifferentialPrivacyNoise(e=.3){const t=Math.random()-.5;return-1/e*Math.sign(t)*Math.log(1-2*Math.abs(t))}secureCompare(e,t){if(e.length!==t.length)return!1;let a=0;for(let r=0;r<e.length;r++)a|=e.charCodeAt(r)^t.charCodeAt(r);return 0===a}async generateAnonymizationKey(e,t=""){const a=`${e}_${t}_${Date.now()}`;return(await this.generateHash(a)).substr(0,8)}async encryptData(e,t){try{const a=new TextEncoder,r=a.encode(t.padEnd(32,"0").substr(0,32)),i=await crypto.subtle.importKey("raw",r,{name:"AES-GCM"},!1,["encrypt"]),n=crypto.getRandomValues(new Uint8Array(12)),s=a.encode(e),o=await crypto.subtle.encrypt({name:"AES-GCM",iv:n},i,s),c=new Uint8Array(n.length+o.byteLength);return c.set(n),c.set(new Uint8Array(o),n.length),btoa(String.fromCharCode(...c))}catch(e){throw console.error("Error encrypting data:",e),e}}async decryptData(e,t){try{const a=new TextEncoder,r=new TextDecoder,i=a.encode(t.padEnd(32,"0").substr(0,32)),n=await crypto.subtle.importKey("raw",i,{name:"AES-GCM"},!1,["decrypt"]),s=new Uint8Array(atob(e).split("").map(e=>e.charCodeAt(0))),o=s.slice(0,12),c=s.slice(12),l=await crypto.subtle.decrypt({name:"AES-GCM",iv:o},n,c);return r.decode(l)}catch(e){throw console.error("Error decrypting data:",e),e}}}class a{constructor(){this.cryptoUtils=new t,this.storageManager=new e}async generateReceipt(e,t,a){try{const r=await this.cryptoUtils.createPrivacyReceipt(e.originalQuery,e.processedQuery,t,a,{piiRemoved:e.piiRemoved,noiseAdded:e.noiseAdded,anonymityScore:e.anonymityScore,semanticChanges:e.semanticChanges,processingTime:e.processingTime,piiDetected:e.piiDetected.map(e=>({type:e.type,confidence:e.confidence,length:e.value.length}))});return console.log("GhostLink: Privacy receipt generated",r.id),r}catch(e){throw console.error("GhostLink: Error generating receipt:",e),e}}async storeReceipt(e){try{await this.storageManager.storeReceipt(e),console.log("GhostLink: Receipt stored successfully",e.id)}catch(e){throw console.error("GhostLink: Error storing receipt:",e),e}}async verifyReceipt(e){try{const t=await this.cryptoUtils.verifyReceipt(e);return console.log(`GhostLink: Receipt ${e.id} verification:`,t?"VALID":"INVALID"),t}catch(e){return console.error("GhostLink: Error verifying receipt:",e),!1}}async getReceipts(e={}){try{let t=await this.storageManager.getReceipts(e.limit);return e.site&&(t=t.filter(t=>t.site===e.site)),e.dateFrom&&(t=t.filter(t=>t.timestamp>=e.dateFrom.getTime())),e.dateTo&&(t=t.filter(t=>t.timestamp<=e.dateTo.getTime())),e.privacyLevel&&(t=t.filter(t=>t.privacyLevel===e.privacyLevel)),t}catch(e){return console.error("GhostLink: Error getting receipts:",e),[]}}async getReceiptStats(){try{const e=await this.storageManager.getReceipts(),t={totalReceipts:e.length,receiptsBySite:{},receiptsByPrivacyLevel:{},averageAnonymityScore:0,totalPIIRemoved:0,recentActivity:[]};if(0===e.length)return t;let a=0;const r={};return e.forEach(e=>{t.receiptsBySite[e.site]=(t.receiptsBySite[e.site]||0)+1,t.receiptsByPrivacyLevel[e.privacyLevel]=(t.receiptsByPrivacyLevel[e.privacyLevel]||0)+1,e.anonymityScore&&(a+=e.anonymityScore),e.piiRemoved&&(t.totalPIIRemoved+=e.piiRemoved);const i=new Date(e.timestamp).toISOString().split("T")[0];r[i]=(r[i]||0)+1}),t.averageAnonymityScore=Math.round(a/e.length),t.recentActivity=Object.entries(r).map(([e,t])=>({date:e,count:t})).sort((e,t)=>t.date.localeCompare(e.date)).slice(0,30),t}catch(e){return console.error("GhostLink: Error calculating receipt stats:",e),{totalReceipts:0,receiptsBySite:{},receiptsByPrivacyLevel:{},averageAnonymityScore:0,totalPIIRemoved:0,recentActivity:[]}}}async exportReceipts(e="json"){try{const t=await this.storageManager.getReceipts();switch(e){case"json":return this.exportAsJSON(t);case"csv":return this.exportAsCSV(t);case"pdf":return await this.exportAsPDF(t);default:throw new Error(`Unsupported export format: ${e}`)}}catch(e){throw console.error("GhostLink: Error exporting receipts:",e),e}}exportAsJSON(e){const t={exportDate:(new Date).toISOString(),version:"1.0.0",totalReceipts:e.length,receipts:e.map(e=>({...e,timestampISO:new Date(e.timestamp).toISOString()}))};return JSON.stringify(t,null,2)}exportAsCSV(e){return[["ID","Timestamp","Site","Privacy Level","PII Removed","Noise Added","Anonymity Score","Original Hash","Processed Hash","Signature"],...e.map(e=>[e.id,new Date(e.timestamp).toISOString(),e.site,e.privacyLevel,e.piiRemoved||0,e.noiseAdded?"Yes":"No",e.anonymityScore||0,e.originalHash,e.processedHash,e.signature||""])].map(e=>e.map(e=>`"${e}"`).join(",")).join("\n")}async exportAsPDF(e){const t=`\nGhostLink Privacy Shield - Receipt Export\nGenerated: ${(new Date).toISOString()}\nTotal Receipts: ${e.length}\n\n${e.map(e=>`\nReceipt ID: ${e.id}\nTimestamp: ${new Date(e.timestamp).toISOString()}\nSite: ${e.site}\nPrivacy Level: ${e.privacyLevel}\nPII Removed: ${e.piiRemoved||0}\nAnonymity Score: ${e.anonymityScore||0}%\nSignature: ${e.signature||"N/A"}\n---\n`).join("")}\n    `;return new Blob([t],{type:"text/plain"})}async verifyAllReceipts(){try{const e=await this.storageManager.getReceipts(),t={totalReceipts:e.length,validReceipts:0,invalidReceipts:0,verificationResults:[]};for(const a of e)try{const e=await this.verifyReceipt(a);t.verificationResults.push({receiptId:a.id,isValid:e}),e?t.validReceipts++:t.invalidReceipts++}catch(e){t.verificationResults.push({receiptId:a.id,isValid:!1,error:e instanceof Error?e.message:"Unknown error"}),t.invalidReceipts++}return t}catch(e){throw console.error("GhostLink: Error verifying all receipts:",e),e}}async cleanupOldReceipts(e){try{const t=Date.now()-24*e*60*60*1e3,a=await this.storageManager.getReceipts(),r=a.filter(e=>e.timestamp>t),i=a.length-r.length;if(i>0){await this.storageManager.clearReceipts();for(const e of r)await this.storageManager.storeReceipt(e);console.log(`GhostLink: Cleaned up ${i} old receipts`)}return i}catch(e){throw console.error("GhostLink: Error cleaning up old receipts:",e),e instanceof Error?e:new Error("Unknown error")}}async generateVerificationReport(){try{const e=await this.verifyAllReceipts(),t=await this.storageManager.getReceipts();return{reportId:this.cryptoUtils.generateReceiptId(),generatedAt:(new Date).toISOString(),summary:{totalReceipts:e.totalReceipts,validReceipts:e.validReceipts,invalidReceipts:e.invalidReceipts,verificationRate:e.totalReceipts>0?Math.round(e.validReceipts/e.totalReceipts*100):0},details:t.map(t=>{const a=e.verificationResults.find(e=>e.receiptId===t.id);return{receiptId:t.id,timestamp:new Date(t.timestamp).toISOString(),site:t.site,isValid:a?.isValid||!1,anonymityScore:t.anonymityScore,piiRemoved:t.piiRemoved}})}}catch(e){throw console.error("GhostLink: Error generating verification report:",e),e}}}class r{constructor(){this.patterns=new Map,this.contextualPatterns=new Map,this.initializePatterns()}initializePatterns(){this.patterns.set("email",[/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,/\b[A-Za-z0-9._%+-]+\s*@\s*[A-Za-z0-9.-]+\s*\.\s*[A-Z|a-z]{2,}\b/g]),this.patterns.set("phone",[/\b(?:\+?1[-.\s]?)?\(?([0-9]{3})\)?[-.\s]?([0-9]{3})[-.\s]?([0-9]{4})\b/g,/\b(?:\+?44[-.\s]?)?(?:\(?0\)?[-.\s]?)?[1-9]\d{8,9}\b/g,/\b(?:\+?33[-.\s]?)?(?:\(?0\)?[-.\s]?)?[1-9](?:[-.\s]?\d{2}){4}\b/g,/\b(?:\+?49[-.\s]?)?(?:\(?0\)?[-.\s]?)?[1-9]\d{1,4}[-.\s]?\d{1,12}\b/g]),this.patterns.set("name",[/\b(?:my name is|i am|i'm|call me|known as)\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\b/gi,/\b([A-Z][a-z]+\s+[A-Z][a-z]+(?:\s+[A-Z][a-z]+)?)\s+(?:here|speaking|calling)\b/gi,/\bMr\.?\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\b/gi,/\bMrs\.?\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\b/gi,/\bMs\.?\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\b/gi,/\bDr\.?\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\b/gi]),this.patterns.set("address",[/\b\d+\s+[A-Za-z0-9\s]+(?:Street|St|Avenue|Ave|Road|Rd|Boulevard|Blvd|Lane|Ln|Drive|Dr|Court|Ct|Place|Pl)\b/gi,/\b[A-Z]{1,2}\d[A-Z\d]?\s*\d[A-Z]{2}\b/g,/\b\d{5}(?:-\d{4})?\b/g,/\b[A-Z]\d[A-Z]\s*\d[A-Z]\d\b/g]),this.patterns.set("ssn",[/\b\d{3}-\d{2}-\d{4}\b/g,/\b\d{3}\s\d{2}\s\d{4}\b/g,/\b\d{9}\b/g]),this.patterns.set("credit_card",[/\b(?:4[0-9]{12}(?:[0-9]{3})?|5[1-5][0-9]{14}|3[47][0-9]{13}|3[0-9]{13}|6(?:011|5[0-9]{2})[0-9]{12})\b/g]),this.patterns.set("national_id",[/\b[A-Z]{2}\s?\d{2}\s?\d{2}\s?\d{2}\s?[A-Z]\b/gi,/\b\d{3}-\d{2}-\d{4}\b/g]),this.patterns.set("date_of_birth",[/\b(?:born|birth|dob|date of birth).*?(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4})\b/gi,/\b(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4}).*?(?:birth|born|dob)\b/gi]),this.patterns.set("ip_address",[/\b(?:[0-9]{1,3}\.){3}[0-9]{1,3}\b/g,/\b(?:[0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}\b/g]),this.contextualPatterns.set("medical",[/\b(?:patient|diagnosis|medical record|health|doctor|hospital|clinic)\b/gi]),this.contextualPatterns.set("financial",[/\b(?:bank|account|credit|loan|mortgage|investment|salary|income)\b/gi]),this.contextualPatterns.set("employment",[/\b(?:employer|company|work|job|employee|colleague|manager|HR)\b/gi])}detectPII(e){const t=[],a=[];for(const[r,i]of this.patterns)for(const n of i){let i;for(n.lastIndex=0;null!==(i=n.exec(e));){const n=i.index,s=n+i[0].length;if(!a.some(e=>n>=e.start&&n<e.end||s>e.start&&s<=e.end||n<=e.start&&s>=e.end)){const o=this.calculateConfidence(r,i[0],e,n);o>.5&&(t.push({type:r,value:i[0],start:n,end:s,confidence:o}),a.push({start:n,end:s}))}}}return t.sort((e,t)=>e.start-t.start)}calculateConfidence(e,t,a,r){let i=.7;const n=this.getSurroundingText(a,r,50);switch(e){case"email":this.isValidEmail(t)&&(i+=.2),n.match(/\b(?:email|contact|reach|write)\b/i)&&(i+=.1);break;case"phone":this.isValidPhoneNumber(t)&&(i+=.2),n.match(/\b(?:phone|call|number|contact)\b/i)&&(i+=.1);break;case"name":this.isLikelyName(t)&&(i+=.1),n.match(/\b(?:name|called|mr|mrs|ms|dr)\b/i)&&(i+=.2);break;case"address":n.match(/\b(?:address|live|located|street|avenue)\b/i)&&(i+=.2);break;case"ssn":this.isValidSSN(t)&&(i+=.3);break;case"credit_card":this.isValidCreditCard(t)&&(i+=.3)}for(const[e,t]of this.contextualPatterns)for(const e of t)if(e.test(n)){i+=.05;break}return Math.min(i,1)}getSurroundingText(e,t,a){const r=Math.max(0,t-a),i=Math.min(e.length,t+a);return e.substring(r,i)}isValidEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e.trim())}isValidPhoneNumber(e){const t=e.replace(/\D/g,"");return t.length>=10&&t.length<=15}isLikelyName(e){const t=e.trim().split(/\s+/);return!(t.length<1||t.length>4)&&t.every(e=>/^[A-Z][a-z]+$/.test(e))}isValidSSN(e){const t=e.replace(/\D/g,"");return 9===t.length&&!["000000000","111111111","222222222","333333333","444444444","555555555","666666666","777777777","888888888","999999999"].includes(t)}isValidCreditCard(e){const t=e.replace(/\D/g,"");if(t.length<13||t.length>19)return!1;let a=0,r=!1;for(let e=t.length-1;e>=0;e--){let i=parseInt(t[e]);r&&(i*=2,i>9&&(i-=9)),a+=i,r=!r}return a%10==0}getPIIStats(e){const t=this.detectPII(e),a={};for(const e of t)a[e.type]=(a[e.type]||0)+1;return a}containsSensitiveInfo(e){return this.detectPII(e).length>0}}class i{constructor(){this.generalizations=new Map,this.contextPatterns=new Map,this.initializeGeneralizations()}initializeGeneralizations(){this.generalizations.set("minimal",new Map([["Google","a major tech company"],["Microsoft","a major tech company"],["Apple","a major tech company"],["Amazon","a major tech company"],["Facebook","a social media company"],["Meta","a social media company"],["Twitter","a social media platform"],["LinkedIn","a professional network"],["NHS","a healthcare system"],["Mayo Clinic","a medical institution"],["Kaiser Permanente","a healthcare provider"],["Goldman Sachs","a financial institution"],["JPMorgan","a financial institution"],["Wells Fargo","a financial institution"],["Bank of America","a financial institution"],["Harvard","a prestigious university"],["MIT","a technical university"],["Stanford","a prestigious university"],["Oxford","a prestigious university"],["Cambridge","a prestigious university"],["New York","a major city"],["London","a major city"],["San Francisco","a major city"],["Los Angeles","a major city"],["Chicago","a major city"],["Boston","a major city"],["Seattle","a major city"],["CEO","senior executive"],["CTO","senior executive"],["CFO","senior executive"],["VP","senior manager"],["Director","manager"],["Manager","supervisor"]])),this.generalizations.set("balanced",new Map([["Google","a tech company"],["Microsoft","a tech company"],["Apple","a tech company"],["Amazon","a tech company"],["Facebook","a social platform"],["Meta","a social platform"],["Twitter","a social platform"],["LinkedIn","a professional platform"],["NHS","a healthcare organization"],["Mayo Clinic","a healthcare organization"],["Kaiser Permanente","a healthcare organization"],["Goldman Sachs","a bank"],["JPMorgan","a bank"],["Wells Fargo","a bank"],["Bank of America","a bank"],["Harvard","a university"],["MIT","a university"],["Stanford","a university"],["Oxford","a university"],["Cambridge","a university"],["New York","a city"],["London","a city"],["San Francisco","a city"],["Los Angeles","a city"],["Chicago","a city"],["Boston","a city"],["Seattle","a city"],["CEO","an executive"],["CTO","an executive"],["CFO","an executive"],["VP","a manager"],["Director","a manager"],["Manager","a supervisor"],["iPhone","a smartphone"],["Android","a mobile platform"],["Windows","an operating system"],["macOS","an operating system"],["Chrome","a web browser"],["Safari","a web browser"],["Firefox","a web browser"]])),this.generalizations.set("maximum",new Map([["Google","an organization"],["Microsoft","an organization"],["Apple","an organization"],["Amazon","an organization"],["Facebook","an organization"],["Meta","an organization"],["Twitter","an organization"],["LinkedIn","an organization"],["NHS","an organization"],["Mayo Clinic","an organization"],["Kaiser Permanente","an organization"],["Goldman Sachs","an organization"],["JPMorgan","an organization"],["Wells Fargo","an organization"],["Bank of America","an organization"],["Harvard","an institution"],["MIT","an institution"],["Stanford","an institution"],["Oxford","an institution"],["Cambridge","an institution"],["New York","a location"],["London","a location"],["San Francisco","a location"],["Los Angeles","a location"],["Chicago","a location"],["Boston","a location"],["Seattle","a location"],["CEO","a role"],["CTO","a role"],["CFO","a role"],["VP","a role"],["Director","a role"],["Manager","a role"],["iPhone","a device"],["Android","a platform"],["Windows","a system"],["macOS","a system"],["Chrome","an application"],["Safari","an application"],["Firefox","an application"]])),this.contextPatterns.set("company_context",[/\b(?:work at|employed by|company|corporation|business|firm)\b/gi]),this.contextPatterns.set("location_context",[/\b(?:live in|located in|based in|from|city|town|state|country)\b/gi]),this.contextPatterns.set("product_context",[/\b(?:using|bought|purchased|device|software|application|app)\b/gi]),this.contextPatterns.set("role_context",[/\b(?:position|job|role|title|work as|employed as)\b/gi])}async generalize(e,t){let a=e,r=0;const i=this.generalizations.get(t);if(!i)return{text:e,changesCount:0};for(const[n,s]of i){const i=new RegExp(`\\b${this.escapeRegex(n)}\\b`,"gi"),o=e.match(i);o&&this.shouldGeneralize(e,n,t)&&(a=a.replace(i,s),r+=o.length)}const n=await this.applyAdditionalTransformations(a,t);return a=n.text,r+=n.changesCount,{text:a,changesCount:r}}shouldGeneralize(e,t,a){if("maximum"===a)return!0;const r=e.toLowerCase().indexOf(t.toLowerCase());if(-1===r)return!1;const i=Math.max(0,r-50),n=Math.min(e.length,r+t.length+50),s=e.substring(i,n);return[/\b(?:my|our|at|work|employed|company|organization)\b/gi,/\b(?:live|based|located|from)\b/gi,/\b(?:use|using|have|own|bought)\b/gi].some(e=>e.test(s))}async applyAdditionalTransformations(e,t){let a=e,r=0;if("balanced"===t||"maximum"===t){const e=this.generalizeNumbers(a);a=e.text,r+=e.changesCount}if("maximum"===t){const e=this.generalizeTemporalReferences(a);a=e.text,r+=e.changesCount}const i=this.generalizeRelationships(a,t);return a=i.text,r+=i.changesCount,{text:a,changesCount:r}}generalizeNumbers(e){let t=e,a=0;return t=t.replace(/\b(?:I am|I'm|age|aged)\s+(\d{1,2})\b/gi,(e,t)=>{a++;const r=parseInt(t);return r<25?e.replace(t,"in my twenties"):r<35?e.replace(t,"in my thirties"):r<45?e.replace(t,"in my forties"):r<55?e.replace(t,"in my fifties"):e.replace(t,"middle-aged")}),t=t.replace(/\b(\d+)\s+years?\s+(?:of\s+)?experience\b/gi,(e,t)=>{a++;const r=parseInt(t);return r<3?"limited experience":r<7?"several years of experience":r<15?"extensive experience":"many years of experience"}),t=t.replace(/\$\d{1,3}(?:,\d{3})*(?:\.\d{2})?/g,()=>(a++,"a significant amount")),{text:t,changesCount:a}}generalizeTemporalReferences(e){let t=e,a=0;return t=t.replace(/\b(?:January|February|March|April|May|June|July|August|September|October|November|December)\s+\d{1,2},?\s+\d{4}\b/gi,()=>(a++,"recently")),t=t.replace(/\bin\s+(19|20)\d{2}\b/gi,()=>(a++,"in recent years")),{text:t,changesCount:a}}generalizeRelationships(e,t){let a=e,r=0;if("maximum"===t){const e=new Map([["my wife","my partner"],["my husband","my partner"],["my boyfriend","my partner"],["my girlfriend","my partner"],["my mother","a family member"],["my father","a family member"],["my brother","a family member"],["my sister","a family member"],["my son","a family member"],["my daughter","a family member"],["my boss","a colleague"],["my manager","a colleague"],["my colleague","a colleague"]]);for(const[t,i]of e){const e=new RegExp(`\\b${this.escapeRegex(t)}\\b`,"gi"),n=a.match(e);n&&(a=a.replace(e,i),r+=n.length)}}return{text:a,changesCount:r}}escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}getAvailablePrivacyLevels(){return Array.from(this.generalizations.keys())}previewGeneralizations(e,t){const a=[],r=this.generalizations.get(t);if(!r)return a;for(const[t,i]of r)new RegExp(`\\b${this.escapeRegex(t)}\\b`,"gi").test(e)&&a.push({original:t,generalized:i});return a}}class n{constructor(){this.DEFAULT_EPSILON=.3,this.MIN_EPSILON=.1,this.MAX_EPSILON=1}async addNoise(e,t=this.DEFAULT_EPSILON){const a=Math.max(this.MIN_EPSILON,Math.min(this.MAX_EPSILON,t));let r=e,i=!1;const n=this.addNumericNoise(r,a);r=n.text,i=i||n.noiseAdded;const s=this.addTemporalNoise(r,a);r=s.text,i=i||s.noiseAdded;const o=this.addCategoricalNoise(r,a);return r=o.text,i=i||o.noiseAdded,{text:r,noiseAdded:i}}addNumericNoise(e,t){let a=e,r=!1;const i=[{pattern:/\b(?:I am|I'm|age|aged)\s+(\d{1,2})\b/gi,sensitivity:1,context:"age"},{pattern:/\b(\d+)\s+years?\s+(?:of\s+)?experience\b/gi,sensitivity:1,context:"experience"},{pattern:/\b(\d+)\s+(?:employees|people|staff|members)\b/gi,sensitivity:5,context:"quantity"},{pattern:/\b(\d+(?:\.\d+)?)\s*%/gi,sensitivity:2,context:"percentage"},{pattern:/\b(?:for|since|about|around)\s+(\d+)\s+years?\b/gi,sensitivity:1,context:"duration"}];for(const{pattern:e,sensitivity:n,context:s}of i)a=a.replace(e,(e,a)=>{const i=parseFloat(a);if(isNaN(i))return e;const o=this.generateLaplaceNoise(t,n),c=Math.max(0,i+o);r=!0;const l=this.roundBasedOnContext(c,s);return e.replace(a,l.toString())});return{text:a,noiseAdded:r}}addTemporalNoise(e,t){let a=e,r=!1;return a=a.replace(/\bin\s+(19|20)(\d{2})\b/gi,(e,a,i)=>{const n=parseInt(a+i),s=(new Date).getFullYear();if(s-n<20){const o=Math.round(this.generateLaplaceNoise(t,1)),c=Math.max(1950,Math.min(s,n+o));return r=!0,e.replace(a+i,c.toString())}return e}),a=a.replace(/\b(January|February|March|April|May|June|July|August|September|October|November|December)\s+(\d{1,2})\b/gi,(e,a,i)=>{const n=parseInt(i),s=Math.round(this.generateLaplaceNoise(t,3)),o=Math.max(1,Math.min(28,n+s));return r=!0,e.replace(i,o.toString())}),{text:a,noiseAdded:r}}addCategoricalNoise(e,t){let a=e,r=!1;const i=new Map([["bachelor",["undergraduate degree","college degree","university degree"]],["master",["graduate degree","postgraduate degree","advanced degree"]],["phd",["doctoral degree","advanced degree","graduate degree"]],["startup",["small company","growing company","new company"]],["enterprise",["large company","established company","major company"]],["healthcare",["medical field","health sector","medical industry"]],["finance",["financial sector","banking industry","financial services"]],["technology",["tech sector","IT industry","technology field"]],["engineer",["technical role","technical position","technical professional"]],["developer",["technical role","technical position","technical professional"]],["analyst",["analytical role","analytical position","data professional"]],["consultant",["advisory role","consulting position","professional advisor"]]]);for(const[e,n]of i){const i=new RegExp(`\\b${this.escapeRegex(e)}\\b`,"gi");a=a.replace(i,e=>Math.random()<Math.exp(t)/(Math.exp(t)+n.length)?e:(r=!0,n[Math.floor(Math.random()*n.length)]))}return{text:a,noiseAdded:r}}generateLaplaceNoise(e,t){const a=t/e,r=Math.random()-.5;return-a*Math.sign(r)*Math.log(1-2*Math.abs(r))}roundBasedOnContext(e,t){switch(t){case"age":case"experience":case"duration":default:return Math.round(e);case"quantity":return e>50?5*Math.round(e/5):Math.round(e);case"percentage":return Math.round(10*e)/10}}escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}calculatePrivacyBudget(e,t){return e*t}recommendEpsilon(e){switch(e){case"low":return 1;case"medium":return.5;case"high":return.1;default:return this.DEFAULT_EPSILON}}validateEpsilon(e){return e>=this.MIN_EPSILON&&e<=this.MAX_EPSILON}getPrivacyGuarantee(e){return e<=.1?"Very strong privacy protection with high noise levels":e<=.5?"Strong privacy protection with moderate noise levels":e<=1?"Moderate privacy protection with low noise levels":"Basic privacy protection with minimal noise"}estimateUtilityLoss(e){const t=(this.MAX_EPSILON-e)/(this.MAX_EPSILON-this.MIN_EPSILON);return Math.round(30*t)}}class s{constructor(){this.piiDetector=new r,this.semanticGeneralizer=new i,this.differentialPrivacy=new n,this.receiptManager=new a,this.cryptoUtils=new t}async processQuery(e,t,a){const r=performance.now();try{let i=e,n=[],s=0,o=!1,c=0;if(t.enablePIIDetection){n=this.piiDetector.detectPII(e);const a=await this.removePII(i,n,t);i=a.text,s=a.removedCount}if(t.enableSemanticGeneralization){const e=await this.semanticGeneralizer.generalize(i,t.privacyLevel);i=e.text,c=e.changesCount}if(t.enableDifferentialPrivacy){const e=await this.differentialPrivacy.addNoise(i,t.noiseLevel);i=e.text,o=e.noiseAdded}const l={processedQuery:i,originalQuery:e,piiDetected:n,piiRemoved:s,noiseAdded:o,semanticChanges:c,anonymityScore:this.calculateAnonymityScore(e,i,s,c,o),processingTime:performance.now()-r};if(t.enableCryptoReceipts)try{const e=await this.receiptManager.generateReceipt(l,a,t.privacyLevel);await this.receiptManager.storeReceipt(e),console.log("GhostLink: Cryptographic receipt generated and stored")}catch(e){console.error("GhostLink: Error generating receipt:",e)}return console.log("GhostLink: Query processed successfully",l),l}catch(e){throw console.error("Error processing query:",e),e}}async removePII(e,t,a){let r=e,i=0;const n=[...t].sort((e,t)=>t.start-e.start);for(const e of n){const t=await this.generateReplacement(e,a);r=r.substring(0,e.start)+t+r.substring(e.end),i++}return{text:r,removedCount:i}}async generateReplacement(e,t){const a=t.privacyLevel;switch(e.type){case"name":return this.generateNameReplacement(e.value,a);case"email":return this.generateEmailReplacement(e.value,a);case"phone":return this.generatePhoneReplacement(e.value,a);case"address":return this.generateAddressReplacement(e.value,a);case"ssn":case"national_id":return"[REDACTED_ID]";case"credit_card":return"[REDACTED_CARD]";case"date_of_birth":return this.generateDateReplacement(e.value,a);case"ip_address":return"[REDACTED_IP]";default:return"[REDACTED]"}}generateNameReplacement(e,t){switch(t){case"minimal":const t=e.split(" ");return t.length>1?`${t[0]} [SURNAME]`:"[NAME]";case"balanced":default:return"[NAME]";case"maximum":return"[PERSON]"}}generateEmailReplacement(e,t){switch(t){case"minimal":const[,t]=e.split("@");return t?`[EMAIL]@${t}`:"[EMAIL]";case"balanced":default:return"[EMAIL]";case"maximum":return"[CONTACT]"}}generatePhoneReplacement(e,t){switch(t){case"minimal":return e.startsWith("+")?`${e.substring(0,3)}[PHONE]`:"[PHONE]";case"balanced":default:return"[PHONE]";case"maximum":return"[CONTACT]"}}generateAddressReplacement(e,t){switch(t){case"minimal":if(e.includes(",")){const t=e.split(",");return`[ADDRESS], ${t[t.length-1].trim()}`}return"[ADDRESS]";case"balanced":default:return"[ADDRESS]";case"maximum":return"[LOCATION]"}}generateDateReplacement(e,t){switch(t){case"minimal":const t=e.match(/\b(19|20)\d{2}\b/);return t?`[DATE_${t[0]}]`:"[DATE]";case"balanced":default:return"[DATE]";case"maximum":return"[TIMEFRAME]"}}calculateAnonymityScore(e,t,a,r,i){let n=0;return e!==t&&(n+=20),n+=Math.min(25*a,50),n+=Math.min(10*r,20),i&&(n+=15),a>0&&r>0&&i&&(n+=10),n+=20*(1-this.calculateTextSimilarity(e,t)),Math.min(Math.round(n),100)}calculateTextSimilarity(e,t){if(e===t)return 1;if(0===e.length||0===t.length)return 0;const a=e.length>t.length?e:t,r=e.length>t.length?t:e;if(0===a.length)return 1;const i=this.levenshteinDistance(a,r);return(a.length-i)/a.length}levenshteinDistance(e,t){const a=Array(t.length+1).fill(null).map(()=>Array(e.length+1).fill(null));for(let t=0;t<=e.length;t++)a[0][t]=t;for(let e=0;e<=t.length;e++)a[e][0]=e;for(let r=1;r<=t.length;r++)for(let i=1;i<=e.length;i++){const n=e[i-1]===t[r-1]?0:1;a[r][i]=Math.min(a[r][i-1]+1,a[r-1][i]+1,a[r-1][i-1]+n)}return a[t.length][e.length]}validateConfig(e){return"boolean"==typeof e.enabled&&["minimal","balanced","maximum"].includes(e.privacyLevel)&&"number"==typeof e.noiseLevel&&e.noiseLevel>=0&&e.noiseLevel<=1}getPrivacyRecommendations(e){const t=[],a=this.piiDetector.detectPII(e);if(0===a.length)return t.push("No sensitive information detected. Current privacy settings are sufficient."),t;const r=new Set(a.map(e=>e.type));return(r.has("ssn")||r.has("credit_card"))&&t.push("⚠️ Highly sensitive information detected. Consider maximum privacy level."),(r.has("name")||r.has("email"))&&t.push("Personal identifiers found. Enable PII detection for better protection."),(r.has("address")||r.has("phone"))&&t.push("Contact information detected. Consider using balanced privacy level."),a.length>3&&t.push("Multiple PII types detected. Enable all privacy features for comprehensive protection."),t}}new class{constructor(){this.storageManager=new e,this.cryptoUtils=new t,this.receiptManager=new a,this.privacyEngine=new s,this.init()}async init(){console.log("GhostLink Privacy Shield: Background service initialized"),chrome.runtime.onMessage.addListener(this.handleMessage.bind(this)),chrome.tabs.onActivated.addListener(this.handleTabActivated.bind(this)),chrome.tabs.onUpdated.addListener(this.handleTabUpdated.bind(this)),await this.initializeDefaultSettings()}async initializeDefaultSettings(){if(!await this.storageManager.getPrivacyConfig()){const e={enabled:!0,privacyLevel:"balanced",enablePIIDetection:!0,enableDifferentialPrivacy:!0,enableSemanticGeneralization:!0,enableCryptoReceipts:!0,enableRelayRouting:!1,supportedSites:["chat.openai.com","claude.ai","bard.google.com","gemini.google.com","poe.com","you.com","perplexity.ai","character.ai"],customRules:[],noiseLevel:.3,retentionDays:30};await this.storageManager.setPrivacyConfig(e),console.log("GhostLink: Default privacy configuration initialized")}}async handleMessage(e,t,a){try{switch(e.type){case"GET_PRIVACY_CONFIG":a({success:!0,data:await this.storageManager.getPrivacyConfig()});break;case"UPDATE_PRIVACY_CONFIG":await this.storageManager.setPrivacyConfig(e.data),a({success:!0});break;case"PROCESS_QUERY":const t=await this.storageManager.getPrivacyConfig();if(!t){a({success:!1,error:"Privacy config not found"});break}a({success:!0,data:await this.privacyEngine.processQuery(e.data.originalQuery,t,e.data.site)});break;case"STORE_RECEIPT":await this.receiptManager.storeReceipt(e.data),a({success:!0});break;case"GET_RECEIPTS":a({success:!0,data:await this.receiptManager.getReceipts(e.data||{})});break;case"VERIFY_RECEIPT":a({success:!0,data:{isValid:await this.receiptManager.verifyReceipt(e.data)}});break;case"EXPORT_RECEIPTS":a({success:!0,data:await this.receiptManager.exportReceipts(e.data?.format||"json")});break;case"GET_RECEIPT_STATS":case"GET_PRIVACY_STATS":a({success:!0,data:await this.receiptManager.getReceiptStats()});break;case"VERIFY_ALL_RECEIPTS":a({success:!0,data:await this.receiptManager.verifyAllReceipts()});break;case"EXPORT_DATA":a({success:!0,data:await this.storageManager.exportData()});break;default:a({success:!1,error:"Unknown message type"})}}catch(e){console.error("GhostLink: Error handling message:",e),a({success:!1,error:e instanceof Error?e.message:"Unknown error"})}}async processPrivacyQuery(e){const t=await this.storageManager.getPrivacyConfig();return t?.enabled?{processedQuery:e.originalQuery,privacyApplied:!0,piiRemoved:0,noiseAdded:!1,anonymityScore:95}:{processedQuery:e.originalQuery,privacyApplied:!1}}async getPrivacyStats(){const e=await this.storageManager.getReceipts(),t=e.length,a=e.reduce((e,t)=>e+(t.piiRemoved||0),0),r=e.length>0?e.reduce((e,t)=>e+(t.anonymityScore||0),0)/e.length:0;return{totalQueries:t,totalPIIRemoved:a,avgAnonymityScore:Math.round(r),lastQuery:e.length>0?e[e.length-1].timestamp:null}}async handleTabActivated(e){const t=await chrome.tabs.get(e.tabId);t.url&&await this.updateTabPrivacyState(t)}async handleTabUpdated(e,t,a){"complete"===t.status&&a.url&&await this.updateTabPrivacyState(a)}async updateTabPrivacyState(e){const t=await this.storageManager.getPrivacyConfig();t&&(t.supportedSites.some(t=>e.url?.includes(t))?(chrome.action.setBadgeText({text:t.enabled?"🛡️":"⚠️",tabId:e.id}),chrome.action.setBadgeBackgroundColor({color:t.enabled?"#10B981":"#EF4444",tabId:e.id})):chrome.action.setBadgeText({text:"",tabId:e.id}))}}})();